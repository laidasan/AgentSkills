# 10. 邊界條件與異常處理

## 目的

預先定義各種邊界情況和異常的處理方式，避免開發時才發現漏洞。

## 撰寫規範

### 基本結構

```markdown
## 邊界條件與異常處理

### 資料邊界
| 情境 | 系統行為 | UI 顯示 |
|------|---------|---------|
| 購物車為空 | 顯示空狀態頁面 | 「購物車是空的，去逛逛吧！」+ 推薦商品 |
| 購物車商品數量 = 上限（50/100） | 禁止再加入商品 | 「購物車已滿，請先結帳或移除部分商品」 |
| 商品數量 = 999 | 「+」按鈕變灰色不可點擊 | - |
| 商品庫存 = 0 | 商品顯示「已售完」標籤 | 「此商品已售完」 |
| 輸入數量為非數字 | 自動恢復為原數量 | 「請輸入有效數量」紅色提示 |

### 權限處理
| 情境 | 系統行為 | UI 顯示 |
|------|---------|---------|
| 訪客存取會員限定功能 | 跳轉至登入頁 | 「請先登入以繼續」 |
| 會員 Session 過期 | 強制登出，跳轉至登入頁 | 「登入逾時，請重新登入」 |

### 系統異常
| 情境 | 系統行為 | UI 顯示 |
|------|---------|---------|
| API 回應超時（> 5 秒） | 顯示錯誤提示，允許重試 | 「網路異常，請稍後再試」 |
| API 回應 500 錯誤 | 顯示錯誤提示，聯絡客服 | 「系統異常，請聯絡客服」 |
| localStorage 容量不足 | 清除過期資料，重試儲存 | 若仍失敗：「儲存失敗，請清理瀏覽器資料」 |

### 操作衝突
| 情境 | 系統行為 | UI 顯示 |
|------|---------|---------|
| 商品在購物車中被其他使用者搶購一空 | 自動移除該商品，發送通知 | 「[商品名稱] 已售完，已自動移除」 |
| 使用者在多裝置同時修改購物車 | 以最後一次操作為準（後端時間戳） | - |
```

## 關鍵要素

### 1. 情境分類
- **資料邊界**：空資料、極值、上限、下限、非法輸入
- **權限處理**：未登入、Session 過期、權限不足
- **系統異常**：網路異常、API 錯誤、儲存空間不足
- **操作衝突**：並發操作、資料競爭、狀態不一致

### 2. 系統行為
描述系統如何處理這個情境：
- 阻止操作（如：禁止加入商品）
- 調整資料（如：自動恢復為原數量）
- 跳轉頁面（如：跳轉至登入頁）
- 發送通知（如：顯示錯誤提示）
- 記錄日誌（如：記錄錯誤資訊）

### 3. UI 顯示
描述使用者看到什麼訊息：
- 提示文字要具體且友善
- 標註顏色（如：紅色、綠色、黃色）
- 說明持續時間（如：3 秒後消失）
- 提供行動建議（如：「請聯絡客服」）

## 邊界情境類型

### 1. 空資料
```markdown
| 購物車為空 | 顯示空狀態頁面 | 「購物車是空的，去逛逛吧！」 |
| 搜尋結果為空 | 顯示空狀態頁面 | 「找不到符合的商品」 |
| 使用者未收藏任何商品 | 顯示空狀態頁面 | 「還沒有收藏商品」 |
```

### 2. 數量極值
```markdown
| 商品數量 = 0 | 顯示確認對話框 | 「確定要移除此商品？」 |
| 商品數量 = 1 | 「-」按鈕顯示刪除圖示 | - |
| 商品數量 = 999 | 「+」按鈕變灰色 | 「已達數量上限」 |
| 商品數量 = 上限 | 禁止繼續增加 | 「數量已達上限」 |
```

### 3. 非法輸入
```markdown
| 輸入非數字 | 自動恢復為原數量 | 「請輸入有效數量」 |
| 輸入負數 | 自動恢復為原數量 | 「數量需大於 0」 |
| 輸入小數 | 自動四捨五入為整數 | - |
| 輸入超大數字 | 自動調整為上限 | 「已調整為最大可購買數量」 |
```

### 4. 長度限制
```markdown
| 商品名稱 > 100 字元 | 截斷並顯示「...」 | - |
| 備註欄位 > 500 字元 | 禁止輸入，顯示提示 | 「備註不得超過 500 字」 |
```

## 異常情境類型

### 1. 網路異常
```markdown
| 網路斷線 | 顯示離線狀態，禁用需網路的功能 | 「目前處於離線狀態」 |
| API 回應超時 | 顯示錯誤提示，允許重試 | 「網路異常，請稍後再試」 |
| 請求失敗 | 顯示錯誤提示，允許重試 | 「載入失敗，點擊重試」 |
```

### 2. 系統錯誤
```markdown
| API 回應 500 | 顯示錯誤提示，聯絡客服 | 「系統異常，請聯絡客服」 |
| API 回應 503 | 顯示維護提示 | 「系統維護中，請稍後再試」 |
| 資料庫錯誤 | 記錄日誌，顯示通用錯誤提示 | 「系統異常，請稍後再試」 |
```

### 3. 儲存空間異常
```markdown
| localStorage 滿 | 清除過期資料，重試儲存 | 若失敗：「儲存失敗，請清理瀏覽器資料」 |
| Cookie 被禁用 | 顯示提示，引導啟用 Cookie | 「請啟用 Cookie 以使用此功能」 |
```

## 撰寫技巧

### 技巧 1：UI 提示要具體且友善
❌ **模糊提示**：「操作失敗」
✅ **具體提示**：「網路異常，請稍後再試」

❌ **技術性提示**：「API timeout error」
✅ **使用者友善提示**：「載入時間過長，請檢查網路連線」

### 技巧 2：提供行動建議
不只告訴使用者發生什麼，也告訴他們該怎麼做：
- 「網路異常，請稍後再試」
- 「系統異常，請聯絡客服」
- 「儲存失敗，請清理瀏覽器資料」

### 技巧 3：區分錯誤等級
- **輕微錯誤**：黃色提示，允許繼續操作
- **中等錯誤**：紅色提示，允許重試
- **嚴重錯誤**：紅色提示，建議聯絡客服或返回首頁

### 技巧 4：考慮自動恢復
對於可自動恢復的情況，應說明恢復邏輯：
```markdown
| localStorage 容量不足 | 清除過期資料（> 7 天），重試儲存 | ... |
```

## 操作衝突處理策略

### 1. Last Write Wins（最後寫入優先）
```markdown
| 多裝置同時修改 | 以最後一次操作為準（時間戳） | - |
```

### 2. 先到先得（First Come First Served）
```markdown
| 多人搶購同一商品 | 先提交訂單者優先，後者顯示「已售完」 | - |
```

### 3. 樂觀鎖定（Optimistic Locking）
```markdown
| 資料版本衝突 | 提示使用者資料已更新，要求重新載入 | 「資料已更新，請重新整理」 |
```

### 4. 悲觀鎖定（Pessimistic Locking）
```markdown
| 其他使用者正在編輯 | 禁止編輯，顯示唯讀模式 | 「此項目正在被編輯中」 |
```

## 注意事項

1. **UI 提示文字要具體**：避免「操作失敗」、「系統錯誤」等模糊描述
2. **涵蓋常見情境**：空資料、極值、非法輸入、網路異常等
3. **提供恢復路徑**：告訴使用者如何恢復或繼續操作
4. **與驗收標準對應**：邊界情境應在功能詳述的驗收標準中測試
5. **考慮並發情況**：多裝置、多使用者同時操作的衝突處理

## 常見錯誤

❌ **錯誤示範 1**：UI 提示不友善
```markdown
| API timeout | 顯示錯誤 | 「Error: Request timeout」 |
```
**問題**：技術性語言，使用者不理解

✅ **正確示範**：
```markdown
| API 回應超時 | 顯示錯誤提示，允許重試 | 「網路異常，請稍後再試」 |
```

❌ **錯誤示範 2**：缺少系統行為
```markdown
| 購物車為空 | - | 「購物車是空的」 |
```
**問題**：沒有說明系統如何處理

✅ **正確示範**：
```markdown
| 購物車為空 | 顯示空狀態頁面，推薦熱門商品 | 「購物車是空的，去逛逛吧！」 |
```

❌ **錯誤示範 3**：未考慮自動恢復
```markdown
| localStorage 滿 | 顯示錯誤 | 「儲存失敗」 |
```
**問題**：沒有考慮自動恢復機制

✅ **正確示範**：
```markdown
| localStorage 滿 | 清除過期資料，重試儲存 | 若仍失敗：「儲存失敗，請清理瀏覽器資料」 |
```

## 適用場景

- ✅ 開發階段，實作錯誤處理邏輯
- ✅ 測試階段，驗證邊界情況和異常處理
- ✅ Code Review，檢查是否涵蓋所有邊界情況
- ✅ 使用者回報問題時，檢查是否有對應的處理邏輯

## 與其他章節的關聯

- **功能詳述**：異常情境應在驗收標準中測試
- **資料與規則定義**：驗證規則的邊界情況應在此章節說明
- **互動流程與使用者行為**：異常流程應對應此章節的異常處理
- **名詞定義**：UI 提示文字使用的術語應與名詞定義一致

## 延伸：錯誤代碼對照表

對於複雜系統，可建立錯誤代碼對照表：

```markdown
### 錯誤代碼對照表

| 錯誤代碼 | 情境 | UI 顯示 |
|---------|------|---------|
| E001 | 商品庫存不足 | 「庫存不足，最多只能購買 X 件」 |
| E002 | 購物車已滿 | 「購物車已滿，請先結帳或移除部分商品」 |
| E003 | 網路逾時 | 「網路異常，請稍後再試」 |
| E004 | 系統維護 | 「系統維護中，預計 X 分鐘後恢復」 |
```

## 驗證檢查

完成此章節後，檢查以下項目：
- [ ] 涵蓋資料邊界、權限處理、系統異常、操作衝突四大類
- [ ] 每個情境都有系統行為和 UI 顯示
- [ ] UI 提示文字具體且友善
- [ ] 考慮自動恢復機制
- [ ] 與功能詳述的驗收標準對應
